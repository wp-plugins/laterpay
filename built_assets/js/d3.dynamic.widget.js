var margin={top:45,right:40,bottom:20,left:50};margin.xAxis=margin.left+margin.right,margin.yAxis=margin.top+margin.bottom;var LPCurve=function(t){var n,e=this;this.container=t,this.interpolation="linear",this.minPrice=0,this.maxPrice=5,this.todayPrice=0,this.pubDays=0,this.defaultPrice=.99,this.i18nDefaultPrice=lpVars.i18nDefaultPrice,this.currency=lpVars.currency,this.i18nDays=lpVars.i18nDays,this.i18nToday=lpVars.i18nToday,this.dragging=!1,n=d3.select(t).append("svg").append("g"),n.append("rect").attr("class","lp_dynamicPricing_background"),n.append("g").attr("class","x axis"),n.append("g").attr("class","y axis"),n.append("defs").append("marker").attr({id:"arrow-x","class":"lp_dynamicPricing_arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,0 V4 L4,2 Z"),n.append("defs").append("marker").attr({id:"arrow-y","class":"lp_dynamicPricing_arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,4 H4 L2,0 Z"),n.append("line").attr("class","lp_dynamicPricing_defaultPrice"),n.append("text").attr("text-anchor","middle").attr("class","lp_dynamicPricing_defaultPrice").text(this.i18nDefaultPrice),n.append("path").attr("class","line"),n.append("rect").attr({"class":"start-price",width:32,rx:3,height:29,ry:3}),n.insert("foreignObject").attr("class","lp_dynamicPricing_startPriceInput").attr("width","44px").attr("height","24px").html('<input type="text">').attr("display","none"),n.append("text").attr("class","start-price").attr("text-anchor","end"),n.append("text").attr("class","lp_dynamicPricing_currency").attr("text-anchor","end").text(this.currency),n.append("path").attr("class","start-price-triangle"),n.append("rect").attr({"class":"end-price",width:32,rx:3,height:29,ry:3}),n.insert("foreignObject").attr("class","lp_dynamicPricing_endPriceInput").attr("width","44px").attr("height","24px").html('<input type="text">').attr("display","none"),n.append("text").attr("class","end-price").attr("text-anchor","end"),n.append("text").attr("class","lp_dynamicPricing_currency").attr("text-anchor","end").text(this.currency),n.append("path").attr("class","end-price-triangle"),this.svg=n,jQuery(window).bind("resize",function(){e.plot()}),jQuery("body").on("click",".start-price, .lp_dynamicPricing_currency, .start-price-triangle",function(){lpc.toggleStartInput("show")}),jQuery(".lp_dynamicPricing_startPriceInput input").change(function(){lpc.toggleStartInput("hide")}),jQuery(".lp_dynamicPricing_startPriceInput input").focusout(function(){lpc.toggleStartInput("hide")}),jQuery(".lp_dynamicPricing_startPriceInput input").keydown(function(t){var n=t.charCode?t.charCode:t.keyCode?t.keyCode:0;13===n&&(t.preventDefault(),lpc.toggleStartInput("hide"))}),jQuery("body").on("click",".end-price, .lp_dynamicPricing_currency, .end-price-triangle",function(){lpc.toggleEndInput("show")}),jQuery(".lp_dynamicPricing_endPriceInput input").change(function(){lpc.toggleEndInput("hide")}),jQuery(".lp_dynamicPricing_endPriceInput input").focusout(function(){lpc.toggleEndInput("hide")}),jQuery(".lp_dynamicPricing_endPriceInput input").keydown(function(t){var n=t.charCode?t.charCode:t.keyCode?t.keyCode:0;13===n&&(t.preventDefault(),lpc.toggleEndInput("hide"))})};LPCurve.prototype.interpolate=function(t){return this.interpolation=t,this},LPCurve.prototype.setPrice=function(t,n,e){return this.minPrice=t,this.maxPrice=n,e&&(this.defaultPrice=e),this},LPCurve.prototype.set_data=function(t){return this.data=t,this},LPCurve.prototype.set_today=function(t,n){return this.pubDays=t,this.todayPrice=n,this},LPCurve.prototype.get_data=function(){return this.data},LPCurve.prototype.plot=function(){function t(t,n){var e=g.invert(d3.event.y);e<x[0]&&(e=x[0]),e>x[1]&&(e=x[1]),t.y=e,0===n&&l.data[0].x===t.x?l.data[1].y=t.y:1===n?l.data[0].y=t.y:0===n&&l.data[l.data.length-1].x===t.x?l.data[l.data.length-2].y=t.y:n===l.data.length-2&&(l.data[l.data.length-1].y=t.y),l.plot()}function n(){l.dragging=!0,jQuery(l.container).toggleClass("lp_is-dragging")}function e(){l.dragging=!1,jQuery(l.container).toggleClass("lp_is-dragging"),lpc.toggleStartInput("update"),lpc.toggleEndInput("update")}function r(){clearInterval(A),jQuery(l.container).toggleClass("ew-resize"),l.dragging=!1;for(var t=0,n=l.data.length;n>t;t++)l.data[t].x=Math.round(l.data[t].x);l.plot()}function i(){jQuery(l.container).toggleClass("ew-resize"),l.dragging=!0}function a(t,n){var e,r=y.invert(d3.event.x),i=n===l.data.length-2,a=n===l.data.length-3;if(i){var c=(r-t.x)/(1e3/D),d=function(){e=+t.x+c,e=Math.max(e,l.data[n].x+.51),e=Math.max(e,29.51),e=Math.min(e,60.49),t.x=e,y.domain(d3.extent(l.data,function(t){return t.x})),l.plot()};clearInterval(A),A=setInterval(d,1e3/D),d()}else a?(e=r,e=Math.max(e,l.data[n].x+.51),e=Math.min(e,60.49),l.data[n+2].x=e>=25?e+5:30,t.x=e,y.domain(d3.extent(l.data,function(t){return t.x})),l.plot()):(e=r,e=Math.max(e,l.data[n].x+.51),e=Math.min(e,l.data[n+2].x-.51),t.x=e,y.domain(d3.extent(l.data,function(t){return t.x})),l.plot())}var c,d,l=this,u=this.svg,p=this.dragging,s=jQuery(this.container).width()-margin.xAxis,o=jQuery(this.container).height()-margin.yAxis,y=d3.scale.linear().range([0,s+10]),g=d3.scale.linear().range([o,0]);d3.select(this.container).select("svg").attr({width:s+margin.xAxis,height:o+margin.yAxis}).select("g").attr("transform","translate("+(margin.left-10)+","+margin.top+")"),u.select(".lp_dynamicPricing_background").transition().duration(p?0:250).attr({width:s+10,height:o});var h=d3.extent(l.data,function(t){return t.x}),x=[0,this.maxPrice],m=d3.svg.axis().scale(y).tickSize(-o,0,0).ticks(7).orient("bottom"),P=d3.svg.axis().scale(g).tickSize(-o,0,0).ticks(7).orient("left");y.domain(h),g.domain(x),u.select("g.x.axis").attr({transform:"translate(0,"+o+")","marker-end":"url(#arrow-x)"}).transition().duration(p?0:250).call(m),u.select("g.y.axis").attr("marker-start","url(#arrow-y)").transition().duration(p?0:250).call(P),u.select("line.lp_dynamicPricing_defaultPrice").transition().duration(p?0:250).attr({x1:0,y1:g(this.defaultPrice),x2:s+10,y2:g(this.defaultPrice)}),u.select("text.lp_dynamicPricing_defaultPrice").transition().duration(p?0:250).attr({x:s/2,y:g(l.defaultPrice)});var f=d3.svg.line().interpolate(this.interpolation).x(function(t){return y(t.x)}).y(function(t){return g(t.y)});u.select("path.line").datum(l.data).transition().duration(p?0:250).attr("d",f);var _=d3.behavior.drag().on("dragstart",i).on("drag",a).on("dragend",r),v=d3.behavior.drag().on("dragstart",n).on("drag",t).on("dragend",e),j=l.data.length,I=u.selectAll("circle.draggable").data(l.data),Q=u.selectAll(".lp_priceLine").data(l.data.slice(1,j)),b=u.selectAll(".today-price-line").data(l.data.slice(1,j)),w=u.selectAll(".lp_priceLineVisible").data(l.data.slice(1,j));u.select("rect.start-price").datum(l.data[0]).call(v).transition().duration(p?0:250).attr({x:function(){return-40},y:function(t){return g(t.y)-14.5}}),u.select("text.start-price").datum(l.data[0]).call(v).transition().duration(p?0:250).attr({x:function(){return-12},y:function(t){return g(t.y)-.5}}).text(function(t){return t.y.toFixed(2)}),u.select("text.lp_dynamicPricing_currency").datum(l.data[0]).call(v).transition().duration(p?0:250).attr({x:function(){return-13},y:function(t){return g(t.y)+9.5}}),u.select("path.start-price-triangle").datum(l.data[0]).call(v).transition().duration(p?0:250).attr("d",function(t){return c=-8,d=g(t.y)-5,"M "+c+" "+d+" l 5 5 l -5 5 z"}),u.select(".lp_dynamicPricing_startPriceInput").datum(l.data[0]).call(v).transition().duration(p?0:250).attr({x:function(){return-38},y:function(t){return g(t.y)-12.5}}),u.select("rect.end-price").datum(l.data[l.data.length-1]).call(v).transition().duration(p?0:250).attr({x:function(){return jQuery(".lp_dynamicPricing_endPriceInput")&&jQuery(".lp_dynamicPricing_endPriceInput").is(":visible")?s:s+16},y:function(t){return g(t.y)-15}}),u.select("text.end-price").datum(l.data[l.data.length-1]).call(v).transition().duration(p?0:250).attr({x:function(){return s+46},y:function(t){return g(t.y)-1}}).text(function(t){return t.y.toFixed(2)}),u.select("text.lp_dynamicPricing_currency").datum(l.data[l.data.length-1]).call(v).transition().duration(p?0:250).attr({x:function(){return s+46},y:function(t){return g(t.y)+9}}),u.select("path.end-price-triangle").datum(l.data[l.data.length-1]).call(v).transition().duration(p?0:250).attr("d",function(t){return c=s+18,d=g(t.y)+5,"M "+c+" "+d+" l 0 -10 l -5 5 z"}),u.select(".lp_dynamicPricing_endPriceInput").datum(l.data[l.data.length-1]).call(v).transition().duration(p?0:250).attr({x:function(){return jQuery(".lp_dynamicPricing_endPriceInput")&&jQuery(".lp_dynamicPricing_endPriceInput input").is(":visible")?s+2:s+20},y:function(t){return g(t.y)-13}});var k=u.selectAll(".x-drag-square").data(l.data.slice(1,j));k.enter().append("rect").attr("class",function(t,n){return n===l.data.length-2?"x-drag-square lp_is-hidden":"x-drag-square"}).call(_),k.exit().remove(),k.transition().duration(p?0:250).attr({x:function(t){return y(t.x)-15},y:function(){return-40},width:30,rx:3,height:30,ry:3});var C=u.selectAll(".x-triangle-bottom").data(l.data.slice(1,j));C.enter().append("path").attr("class",function(t,n){return n===l.data.length-2?"x-triangle-bottom lp_is-hidden":"x-triangle-bottom"}).call(_),C.exit().remove(),C.transition().duration(p?0:250).attr("d",function(t){return c=y(t.x)-5,d=-10,"M "+c+" "+d+" l 10 0 l -5 5 z"});var L=u.selectAll(".x-text-days").data(l.data.slice(1,j));L.enter().append("text").attr("class",function(t,n){return n===l.data.length-2?"x-text-days lp_is-hidden":"x-text-days"}).call(_),L.exit().remove(),L.transition().duration(p?0:250).text(this.i18nDays).attr({x:function(t){return y(t.x)},y:function(){return-16},height:30,"text-anchor":"middle"});var M=u.selectAll(".x-text").data(l.data.slice(1,j));M.enter().append("text").attr("class",function(t,n){return n===l.data.length-2?"x-text lp_is-hidden":"x-text"}).call(_),M.exit().remove(),M.transition().duration(p?0:250).text(function(t){return Math.round(t.x)}).attr({x:function(t){return y(t.x)},y:function(){return-26},height:30,"text-anchor":"middle"}),w.enter().append("line").attr("class",function(t,n){return n===l.data.length-2?"lp_priceLine lp_is-hidden":"lp_priceLineVisible"}),w.exit().remove(),w.transition().duration(p?0:250).attr({x1:function(t){return y(t.x)},y1:function(){return 0},x2:function(t){return y(t.x)},y2:function(t){return g(t.y)}}),Q.enter().append("line").attr("class",function(t,n){return n===l.data.length-2?"lp_priceLine lp_is-hidden":"lp_priceLine"}).call(_),Q.exit().remove(),Q.transition().duration(p?0:250).attr({x1:function(t){return y(t.x)},y1:function(){return 0},x2:function(t){return y(t.x)},y2:function(t){return g(t.y)}}),I.enter().append("circle").attr("class",function(t,n){return 0===n||n===l.data.length-1?"draggable lp_is-hidden":"draggable"}).attr("r",0).call(v),I.transition().duration(p?0:250).attr({r:5,cx:function(t){return y(t.x)},cy:function(t){return g(t.y)}}),I.exit().remove(),this.pubDays>0&&(b.enter().append("line").attr("class","lp_current-price-line"),b.exit().remove(),b.transition().duration().attr({x1:function(){return y(lpc.pubDays)},y1:function(){return g(0)},x2:function(){return y(lpc.pubDays)},y2:function(){return g(lpc.maxPrice)}}),u.append("text").attr("class","lp_dynamicPricing_defaultPrice").attr("text-anchor","end").text(this.i18nToday).datum({x:lpc.pubDays,y:lpc.todayPrice}).call(v).attr({x:function(){return y(parseInt(lpc.pubDays,10)+2)},y:function(){return g(-10)}}));var A,D=60},LPCurve.prototype.toggleStartInput=function(t){var n=1,e=lpc.get_data(),r=e[0].y,i=jQuery(".lp_dynamicPricing_startPriceInput input").val();if(i=parseFloat(i.indexOf(",")>-1?i.replace(",","."):i),"hide"===t)i>this.maxPrice?(jQuery(".lp_dynamicPricing_startPriceInput input").val(this.maxPrice),e[0].y=this.maxPrice,e[1].y=this.maxPrice):i<this.minPrice&&0!==i?(jQuery(".lp_dynamicPricing_startPriceInput input").val(this.minPrice),e[0].y=this.minPrice,e[1].y=this.minPrice):0===i&&(e[0].y=i,e[1].y=i),lpc.set_data(e),jQuery("rect.start-price").attr("width","32px"),jQuery(".lp_dynamicPricing_startPriceInput").hide(),jQuery("path.start-price-triangle, text.lp_dynamicPricing_currency, text.start-price").show(),lpc.plot();else if("show"===t)jQuery("rect.start-price").attr("width","50px"),jQuery("path.start-price-triangle, text.lp_dynamicPricing_currency, text.start-price").hide(),jQuery(".lp_dynamicPricing_startPriceInput").show(),jQuery(".lp_dynamicPricing_startPriceInput input").val(r.toFixed(2));else if("update"===t&&jQuery(".lp_dynamicPricing_startPriceInput input").is(":visible")){var a=Math.abs(r-i);a>n&&jQuery(".lp_dynamicPricing_startPriceInput input").val(r.toFixed(2))}},LPCurve.prototype.toggleEndInput=function(t){var n=1,e=lpc.get_data(),r=e[2].y,i=jQuery(".lp_dynamicPricing_endPriceInput input").val(),a=jQuery(this.container).width()-margin.xAxis;if(i=parseFloat(i.indexOf(",")>-1?i.replace(",","."):i),"hide"===t)i>this.maxPrice?(jQuery(".lp_dynamicPricing_endPriceInput input").val(this.maxPrice),e[0].y=this.maxPrice,e[1].y=this.maxPrice):i<this.minPrice&&0!==i?(jQuery(".lp_dynamicPricing_endPriceInput input").val(this.minPrice),e[2].y=this.minPrice,e[3].y=this.minPrice):0===i&&(e[2].y=i,e[3].y=i),lpc.set_data(e),jQuery("rect.end-price").attr("width","32px"),jQuery(".lp_dynamicPricing_endPriceInput").hide(),jQuery("path.end-price-triangle, text.lp_dynamicPricing_currency, text.end-price").show(),lpc.plot();else if("show"===t)jQuery("rect.end-price").attr("width","50px").attr("x",a),jQuery("path.end-price-triangle, text.lp_dynamicPricing_currency, text.end-price").hide(),jQuery(".lp_dynamicPricing_endPriceInput").attr("x",a+2).show(),jQuery(".lp_dynamicPricing_endPriceInput input").val(r.toFixed(2));else if("update"===t&&jQuery(".lp_dynamicPricing_endPriceInput input").is(":visible")){var c=Math.abs(r-i);c>n&&jQuery(".lp_dynamicPricing_endPriceInput input").val(r.toFixed(2))}};