var margin={top:37,right:40,bottom:15,left:50};margin.xAxis=margin.left+margin.right,margin.yAxis=margin.top+margin.bottom;var DynamicPricingWidget=function(i){var t,n=this;this.container=i,this.interpolation="linear",this.minPrice=0,this.maxPrice=5,this.defaultPrice=.49,this.currentPrice=0,this.pubDays=0,this.currency=lpVars.currency,this.i18nDefaultPrice=lpVars.i18nDefaultPrice,this.i18nDays=lpVars.i18nDays,this.i18nToday=lpVars.i18nToday,this.dragging=!1,t=d3.select(i).append("svg").attr("class","lp_dynamic-pricing__svg").append("g").attr("class","lp_dynamic-pricing__svg-group"),t.append("rect").attr("class","lp_dynamic-pricing__graph-background"),t.append("g").attr("class","lp_dynamic-pricing__axis lp_dynamic-pricing__axis--x"),t.append("g").attr("class","lp_dynamic-pricing__axis lp_dynamic-pricing__axis--y"),t.append("defs").append("marker").attr({id:"lp_dynamic-pricing__axis-arrowhead--x","class":"lp_dynamic-pricing__axis-arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,0 V4 L4,2 Z"),t.append("defs").append("marker").attr({id:"lp_dynamic-pricing__axis-arrowhead--y","class":"lp_dynamic-pricing__axis-arrowhead",refX:2,refY:2,markerWidth:4,markerHeight:4,orient:"auto"}).append("path").attr("d","M0,4 H4 L2,0 Z"),t.append("line").attr("class","lp_dynamic-pricing__default-price-marker"),t.append("rect").attr({"class":"lp_dynamic-pricing__default-price-label-background",width:66,height:16}),t.append("text").attr("transform","translate(0, 2.5)").attr("class","lp_dynamic-pricing__default-price-label").attr("text-anchor","middle").text(this.i18nDefaultPrice),t.append("path").attr("class","lp_dynamic-pricing__price-curve"),t.append("rect").attr({"class":"lp_dynamic-pricing__start-price-handle",width:32,rx:3,height:29,ry:3}),t.append("path").attr("class","lp_dynamic-pricing__start-price-handle-triangle"),t.insert("foreignObject").attr({"class":"lp_dynamic-pricing__start-price-input-wrapper",width:"52px",height:"30px"}).html('<input type="text" class="lp_dynamic-pricing__start-price-input">'),t.append("text").attr("class","lp_dynamic-pricing__start-price-value lp_dynamic-pricing__handle-text").attr("text-anchor","end"),t.append("text").attr("class","lp_dynamic-pricing__start-price-currency lp_dynamic-pricing__handle-text lp_dynamic-pricing__handle-unit").attr("text-anchor","end").text(this.currency),t.append("rect").attr({"class":"lp_dynamic-pricing__end-price-handle",width:32,rx:3,height:29,ry:3}),t.append("path").attr("class","lp_dynamic-pricing__end-price-handle-triangle"),t.insert("foreignObject").attr({"class":"lp_dynamic-pricing__end-price-input-wrapper",width:"52px",height:"30px"}).html('<input type="text" class="lp_dynamic-pricing__end-price-input">'),t.append("text").attr("class","lp_dynamic-pricing__end-price-value lp_dynamic-pricing__handle-text").attr("text-anchor","end"),t.append("text").attr("class","lp_dynamic-pricing__end-price-currency lp_dynamic-pricing__handle-text lp_dynamic-pricing__handle-unit").attr("text-anchor","end").text(this.currency),this.svg=t,jQuery(window).bind("resize",function(){n.plot()}),jQuery("body").on("click",".lp_dynamic-pricing__start-price-handle, .lp_dynamic-pricing__start-price-value, .lp_dynamic-pricing__start-price-currency",function(){dynamicPricingWidget.toggleStartInput("show")}).on("focusout",".lp_dynamic-pricing__start-price-input",function(){dynamicPricingWidget.toggleStartInput("save")}).on("keydown",".lp_dynamic-pricing__start-price-input",function(i){13===i.keyCode&&(i.preventDefault(),dynamicPricingWidget.toggleStartInput("save"))}).on("keydown",".lp_dynamic-pricing__start-price-input",function(i){27===i.keyCode&&(i.preventDefault(),dynamicPricingWidget.toggleStartInput("cancel"))}),jQuery("body").on("click",".lp_dynamic-pricing__end-price-handle, .lp_dynamic-pricing__end-price-value, .lp_dynamic-pricing__end-price-currency",function(){dynamicPricingWidget.toggleEndInput("show")}).on("focusout",".lp_dynamic-pricing__end-price-input",function(){dynamicPricingWidget.toggleEndInput("save")}).on("keydown",".lp_dynamic-pricing__end-price-input",function(i){13===i.keyCode&&(i.preventDefault(),dynamicPricingWidget.toggleEndInput("save"))}).on("keydown",".lp_dynamic-pricing__end-price-input",function(i){27===i.keyCode&&(i.preventDefault(),dynamicPricingWidget.toggleEndInput("cancel"))})};DynamicPricingWidget.prototype.interpolate=function(i){return this.interpolation=i,this},DynamicPricingWidget.prototype.setPrice=function(i,t,n){return this.minPrice=i,this.maxPrice=t,n&&(this.defaultPrice=n),this},DynamicPricingWidget.prototype.set_data=function(i){return this.data=i,this},DynamicPricingWidget.prototype.get_data=function(){return this.data},DynamicPricingWidget.prototype.set_today=function(i,t){return this.pubDays=i,this.currentPrice=t,this},DynamicPricingWidget.prototype._setDimensions=function(){this.dimensions={width:jQuery(this.container).width()-margin.xAxis,height:jQuery(this.container).height()-margin.yAxis}},DynamicPricingWidget.prototype._setScale=function(){this.scale={x:d3.scale.linear().range([0,this.dimensions.width+10]),y:d3.scale.linear().range([this.dimensions.height,0])}},DynamicPricingWidget.prototype._plotAxes=function(){this.xExtent=d3.extent(this.data,function(i){return i.x}),this.yExtent=[0,this.maxPrice];var i=d3.svg.axis().scale(this.scale.x).tickSize(-this.dimensions.height,0,0).ticks(7).orient("bottom"),t=d3.svg.axis().scale(this.scale.y).tickSize(-this.dimensions.height,0,0).ticks(7).orient("left");this.scale.x.domain(this.xExtent),this.scale.y.domain(this.yExtent),this.svg.select(".lp_dynamic-pricing__axis--x").attr({transform:"translate(0,"+this.dimensions.height+")","marker-end":"url(#lp_dynamic-pricing__axis-arrowhead--x)"}).transition().duration(this.dragging?0:250).call(i),this.svg.select(".lp_dynamic-pricing__axis--y").attr("marker-start","url(#lp_dynamic-pricing__axis-arrowhead--y)").transition().duration(this.dragging?0:250).call(t),d3.selectAll(".tick").select("line").attr("class","lp_dynamic-pricing__grid-line"),d3.selectAll(".tick").select("text").attr("class","lp_dynamic-pricing__grid-line-label"),this.svg.select(".lp_dynamic-pricing__default-price-marker").transition().duration(this.dragging?0:250).attr({x1:0,y1:this.scale.y(this.defaultPrice),x2:this.dimensions.width+10,y2:this.scale.y(this.defaultPrice)}),this.svg.select(".lp_dynamic-pricing__default-price-label-background").transition().duration(this.dragging?0:250).attr({x:(this.dimensions.width-66)/2,y:this.scale.y(this.defaultPrice)-9}),this.svg.select(".lp_dynamic-pricing__default-price-label").transition().duration(this.dragging?0:250).attr({x:this.dimensions.width/2,y:this.scale.y(this.defaultPrice)})},DynamicPricingWidget.prototype._plotPriceCurve=function(){var i=this,t=d3.svg.line().interpolate(this.interpolation).x(function(t){return i.scale.x(t.x)}).y(function(t){return i.scale.y(t.y)});this.svg.select(".lp_dynamic-pricing__price-curve").datum(this.data).transition().duration(this.dragging?0:250).attr("d",t)},DynamicPricingWidget.prototype._setDragBehavior=function(){function i(){this.dragging=!0}function t(i,t){var n=this.scale.y.invert(d3.event.y);n<this.yExtent[0]&&(n=this.yExtent[0]),n>this.yExtent[1]&&(n=this.yExtent[1]),i.y=n,0===t&&this.data[0].x===i.x?this.data[1].y=i.y:1===t?this.data[0].y=i.y:0===t&&this.data[this.data.length-1].x===i.x?this.data[this.data.length-2].y=i.y:t===this.data.length-2&&(this.data[this.data.length-1].y=i.y),this.plot()}function n(){this.dragging=!1}function a(){this.dragging=!0}function e(i,t){var n,a=this.scale.x.invert(d3.event.x),e=t===this.data.length-2,r=t===this.data.length-3;if(e){var d=(a-i.x)/(1e3/s),l=function(){n=+i.x+d,n=Math.max(n,this.data[t].x+.51),n=Math.max(n,29.51),n=Math.min(n,60.49),i.x=n,this.scale.x.domain(d3.extent(this.data,function(i){return i.x})),this.plot()};clearInterval(c),c=setInterval(l,1e3/s),l()}else r?(n=a,n=Math.max(n,this.data[t].x+.51),n=Math.min(n,60.49),this.data[t+2].x=n>=25?n+5:30,i.x=n,this.scale.x.domain(d3.extent(this.data,function(i){return i.x})),this.plot()):(n=a,n=Math.max(n,this.data[t].x+.51),n=Math.min(n,this.data[t+2].x-.51),i.x=n,this.scale.x.domain(d3.extent(this.data,function(i){return i.x})),this.plot())}function r(){clearInterval(c),this.dragging=!1;for(var i=0,t=this.data.length;t>i;i++)this.data[i].x=Math.round(this.data[i].x);this.plot()}var c,s=60;this.dragBehavior={x:d3.behavior.drag().on("dragstart",a.bind(this)).on("drag",e.bind(this)).on("dragend",r.bind(this)),y:d3.behavior.drag().on("dragstart",i.bind(this)).on("drag",t.bind(this)).on("dragend",n.bind(this))}},DynamicPricingWidget.prototype._plotStartPriceHandle=function(){var i=this;this.svg.select(".lp_dynamic-pricing__start-price-handle").datum(this.data[0]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return-38},y:function(t){return i.scale.y(t.y)-14.5}}),this.svg.select(".lp_dynamic-pricing__start-price-handle-triangle").datum(this.data[0]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr("d",function(t){var n=-6,a=i.scale.y(t.y)-5;return"M "+n+" "+a+" l 5 5 l -5 5 z"}),this.svg.select(".lp_dynamic-pricing__start-price-value").datum(this.data[0]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return-10},y:function(t){return i.scale.y(t.y)-.5}}).text(function(i){return"de_DE"===lpVars.locale?i.y.toFixed(2).replace(".",","):i.y.toFixed(2)}),this.svg.select(".lp_dynamic-pricing__start-price-currency").datum(this.data[0]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return-11},y:function(t){return i.scale.y(t.y)+9.5}}),this.svg.select(".lp_dynamic-pricing__start-price-input-wrapper").datum(this.data[0]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return-38},y:function(t){return i.scale.y(t.y)-14}})},DynamicPricingWidget.prototype._plotEndPriceHandle=function(){var i=this;this.svg.select(".lp_dynamic-pricing__end-price-handle").datum(this.data[this.data.length-1]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return jQuery(".lp_dynamic-pricing__end-price-input-wrapper")&&jQuery(".lp_dynamic-pricing__end-price-input").is(":visible")?i.dimensions.width:i.dimensions.width+16},y:function(t){return i.scale.y(t.y)-15}}),this.svg.select(".lp_dynamic-pricing__end-price-value").datum(this.data[this.data.length-1]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return i.dimensions.width+44},y:function(t){return i.scale.y(t.y)-1}}).text(function(i){return"de_DE"===lpVars.locale?i.y.toFixed(2).replace(".",","):i.y.toFixed(2)}),this.svg.select(".lp_dynamic-pricing__end-price-currency").datum(this.data[this.data.length-1]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return i.dimensions.width+44},y:function(t){return i.scale.y(t.y)+9}}),this.svg.select(".lp_dynamic-pricing__end-price-handle-triangle").datum(this.data[this.data.length-1]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr("d",function(t){var n=i.dimensions.width+16,a=i.scale.y(t.y)+5;return"M "+n+" "+a+" l 0 -10 l -5 5 z"}),this.svg.select(".lp_dynamic-pricing__end-price-input-wrapper").datum(this.data[this.data.length-1]).call(this.dragBehavior.y).transition().duration(this.dragging?0:250).attr({x:function(){return i.dimensions.width-4},y:function(t){return i.scale.y(t.y)-15}})},DynamicPricingWidget.prototype._plotDaysHandle=function(){var i=this,t=this.svg.selectAll(".lp_dynamic-pricing__price-change-days-handle").data(this.data.slice(1,this.data.length));t.enter().append("rect").attr("class",function(t,n){var a="lp_dynamic-pricing__price-change-days-handle";return n===i.data.length-2&&(a+=" lp_is-hidden"),a}).call(this.dragBehavior.x),t.exit().remove(),t.transition().duration(this.dragging?0:250).attr({x:function(t){return i.scale.x(t.x)-15},y:function(){return-35},width:30,rx:3,height:30,ry:3});var n=this.svg.selectAll(".lp_dynamic-pricing__price-change-days-handle-triangle").data(this.data.slice(1,this.data.length));n.enter().append("path").attr("class",function(t,n){var a="lp_dynamic-pricing__price-change-days-handle-triangle";return n===i.data.length-2&&(a+=" lp_is-hidden"),a}).call(this.dragBehavior.x),n.exit().remove(),n.transition().duration(this.dragging?0:250).attr("d",function(t){var n=i.scale.x(t.x)-5,a=-5;return"M "+n+" "+a+" l 10 0 l -5 5 z"});var a=this.svg.selectAll(".lp_dynamic-pricing__price-change-days-value").data(this.data.slice(1,this.data.length));a.enter().append("text").attr("class",function(t,n){var a="lp_dynamic-pricing__price-change-days-value lp_dynamic-pricing__handle-text";return n===i.data.length-2&&(a+=" lp_is-hidden"),a}).call(this.dragBehavior.x),a.exit().remove(),a.transition().duration(this.dragging?0:250).text(function(i){return Math.round(i.x)}).attr({x:function(t){return i.scale.x(t.x)},y:function(){return-21},height:30,"text-anchor":"middle"});var e=this.svg.selectAll(".lp_dynamic-pricing__price-change-days-unit").data(this.data.slice(1,this.data.length));e.enter().append("text").attr("class",function(t,n){var a="lp_dynamic-pricing__price-change-days-unit lp_dynamic-pricing__handle-text lp_dynamic-pricing__handle-unit";return n===i.data.length-2&&(a+=" lp_is-hidden"),a}).call(this.dragBehavior.x),e.exit().remove(),e.transition().duration(this.dragging?0:250).text(this.i18nDays).attr({x:function(t){return i.scale.x(t.x)},y:function(){return-11},height:30,"text-anchor":"middle"})},DynamicPricingWidget.prototype._plotXMarker=function(){var i=this,t=this.svg.selectAll(".lp_dynamic-pricing__x-axis-marker").data(this.data.slice(1,this.data.length));t.enter().append("line").attr("class",function(t,n){var a="lp_dynamic-pricing__x-axis-marker";return n===i.data.length-2&&(a+=" lp_is-hidden"),a}).call(this.dragBehavior.x),t.exit().remove(),t.transition().duration(this.dragging?0:250).attr({x1:function(t){return i.scale.x(t.x)},y1:function(){return 0},x2:function(t){return i.scale.x(t.x)},y2:function(t){return i.scale.y(t.y)-4.5}})},DynamicPricingWidget.prototype._plotPriceCurvePoints=function(){var i=this,t=this.svg.selectAll(".lp_dynamic-pricing__price-curve-point").data(this.data);t.enter().append("circle").attr("class",function(t,n){var a="lp_dynamic-pricing__price-curve-point";return(0===n||n===i.data.length-1)&&(a+=" lp_is-hidden"),a}).attr("r",0),t.transition().duration(this.dragging?0:250).attr({r:4.5,cx:function(t){return i.scale.x(t.x)},cy:function(t){return i.scale.y(t.y)}}),t.exit().remove()},DynamicPricingWidget.prototype._plotPriceMarker=function(){var i=this,t=this.svg.selectAll(".lp_dynamic-pricing__current-price-marker").data(this.data.slice(1,this.data.length));this.pubDays>0&&(t.enter().append("line").attr("class","lp_dynamic-pricing__current-price-marker"),t.exit().remove(),t.transition().duration(this.dragging?0:250).attr({x1:function(){return i.scale.x(dynamicPricingWidget.pubDays)},y1:function(){return i.scale.y(0)},x2:function(){return i.scale.x(dynamicPricingWidget.pubDays)},y2:function(){return i.scale.y(dynamicPricingWidget.maxPrice)}}))},DynamicPricingWidget.prototype.plot=function(){this._setDimensions(),this._setScale(),d3.select(".lp_dynamic-pricing__svg").attr({width:this.dimensions.width+margin.xAxis,height:this.dimensions.height+margin.yAxis}).select(".lp_dynamic-pricing__svg-group").attr("transform","translate("+(margin.left-11)+","+margin.top+")"),this.svg.select(".lp_dynamic-pricing__graph-background").transition().duration(this.dragging?0:250).attr({width:this.dimensions.width+10,height:this.dimensions.height}),this._plotAxes(),this._plotPriceCurve(),this._plotPriceCurvePoints(),this._setDragBehavior(),this._plotStartPriceHandle(),this._plotEndPriceHandle(),this._plotDaysHandle(),this._plotXMarker(),this._plotPriceMarker()},DynamicPricingWidget.prototype.toggleStartInput=function(i){var t=dynamicPricingWidget.get_data(),n=t[0].y.toFixed(2),a=jQuery(".lp_dynamic-pricing__start-price-handle, .lp_dynamic-pricing__start-price-handle-triangle, .lp_dynamic-pricing__start-price-value, .lp_dynamic-pricing__start-price-currency"),e=jQuery(".lp_dynamic-pricing__start-price-input"),r=e.val();r=parseFloat(r.indexOf(",")>-1?r.replace(",","."):r),"de_DE"===lpVars.locale&&(n=n.replace(".",",")),"show"===i?(a.hide(),e.val(n).show().focus()):"save"===i?(r>this.maxPrice?r=this.maxPrice:r<this.minPrice&&0!==r&&(r=this.minPrice),t[0].y=r,t[1].y=r,e.hide(),a.show(),dynamicPricingWidget.set_data(t),dynamicPricingWidget.plot()):"cancel"===i&&(e.hide(),a.show())},DynamicPricingWidget.prototype.toggleEndInput=function(i){var t=dynamicPricingWidget.get_data(),n=t[2].y.toFixed(2),a=jQuery(".lp_dynamic-pricing__end-price-handle, .lp_dynamic-pricing__end-price-handle-triangle, .lp_dynamic-pricing__end-price-value, .lp_dynamic-pricing__end-price-currency"),e=jQuery(".lp_dynamic-pricing__end-price-input"),r=e.val();r=parseFloat(r.indexOf(",")>-1?r.replace(",","."):r),"de_DE"===lpVars.locale&&(n=n.replace(".",",")),"show"===i?(a.hide(),e.val(n).show().focus()):"save"===i?(r>this.maxPrice?r=this.maxPrice:r<this.minPrice&&0!==r&&(r=this.minPrice),t[2].y=r,t[3].y=r,e.hide(),a.show(),dynamicPricingWidget.set_data(t),dynamicPricingWidget.plot()):"cancel"===i&&(e.hide(),a.show())};